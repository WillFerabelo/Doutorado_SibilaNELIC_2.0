#!/bin/bash

# Define o caminho absoluto do projeto
PROJETO_DIR="/Users/williamfernandes/Documents/Doutorado/Doutorado Sibila 3.0"
URL="http://localhost:8502"

# Caminho completo do Python
PYTHON="/Library/Frameworks/Python.framework/Versions/3.11/bin/python3"

# Limpa variáveis de ambiente que podem causar conflito
unset PYTHONPATH
unset PYTHONHOME

# Define PATH mínimo
export PATH="/Library/Frameworks/Python.framework/Versions/3.11/bin:/usr/bin:/bin:/usr/sbin:/sbin"

# Verifica se a porta 8502 já está em uso
if lsof -Pi :8502 -sTCP:LISTEN -t >/dev/null 2>&1 ; then
    # Sistema já está rodando, apenas abre o navegador
    open "$URL"
    osascript -e 'display notification "O sistema já está em execução. Abrindo navegador..." with title "NELIC.DEV"'
else
    # Mostra notificação de início
    osascript -e 'display notification "Iniciando servidor..." with title "NELIC.DEV"'

    # Navega para o diretório do projeto
    cd "$PROJETO_DIR" || exit 1

    # Inicia o Streamlit em background usando python -m streamlit
    "$PYTHON" -m streamlit run sibila_code_21.py --server.port=8502 --browser.gatherUsageStats=false > /tmp/nelic_dev.log 2>&1 &

    # Aguarda o servidor iniciar
    sleep 5

    # Tenta até 15 vezes (15 segundos) para verificar se o servidor iniciou
    for i in {1..15}; do
        if lsof -Pi :8502 -sTCP:LISTEN -t >/dev/null 2>&1 ; then
            # Servidor iniciou, abre o navegador
            open "$URL"
            osascript -e 'display notification "Sistema iniciado com sucesso!" with title "NELIC.DEV"'
            exit 0
        fi
        sleep 1
    done

    # Se chegou aqui, houve erro - mostra o log
    LOG_CONTENT=$(tail -20 /tmp/nelic_dev.log 2>/dev/null)
    osascript -e "display alert \"NELIC.DEV - Erro\" message \"Erro ao iniciar. Verifique /tmp/nelic_dev.log\" as critical"
fi
